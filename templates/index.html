<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Random Fact</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}">
</head>
<body class="bg-dark text-light">
  <main class="container py-5">
    <div class="mx-auto card bg-black border-secondary p-4 app-card">
      <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <h1 class="h4 mb-0">Loading-Screen Fact</h1>
        <a class="btn btn-outline-secondary" href="/admin">Admin</a>
      </div>

      <div class="mt-4">
        <p id="factText" class="lead mb-0 fact-text fact-loading">
          Klick auf den Button, um einen Fact zu bekommen.
        </p>
      </div>

      <div id="loadingPanel" class="loading-panel mt-4 d-none" aria-hidden="true">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="d-flex align-items-center gap-2">
            <div class="spinner"></div>
            <div id="loadingText" class="small text-secondary">Lade…</div>
          </div>
          <div id="loadingPct" class="small text-secondary">0%</div>
        </div>

        <div class="progress" style="height: 10px;">
          <div id="loadingBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
      </div>

      <div class="d-flex gap-2 flex-wrap mt-4">
        <button id="btn" class="btn btn-primary btn-lg">Random Fact</button>
        <button id="btnSkip" class="btn btn-outline-secondary btn-lg d-none" type="button">Skip</button>
      </div>
    </div>
  </main>

  <script>
    const btn = document.getElementById("btn");
    const btnSkip = document.getElementById("btnSkip");
    const factText = document.getElementById("factText");

    const loadingPanel = document.getElementById("loadingPanel");
    const loadingBar = document.getElementById("loadingBar");
    const loadingText = document.getElementById("loadingText");
    const loadingPct = document.getElementById("loadingPct");

    let isLoading = false;
    let skipRequested = false;

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function fetchFact(){
      const res = await fetch("/api/random_fact", { cache: "no-store" });
      const data = await res.json();
      return (data.text || "Kein Fact erhalten.").trim();
    }

    async function fetchLoadingLine(){
      try{
        const res = await fetch("/api/random_loading", { cache: "no-store" });
        const data = await res.json();
        return (data.text || "Lade…").trim();
      }catch(e){
        return "Lade…";
      }
    }

    async function startLoadingUI(){
      loadingPanel.classList.remove("d-none");
      btnSkip.classList.remove("d-none");
      loadingBar.style.width = "0%";
      loadingPct.textContent = "0%";
      loadingText.textContent = await fetchLoadingLine();
      skipRequested = false;
    }

    function stopLoadingUI(){
      loadingPanel.classList.add("d-none");
      btnSkip.classList.add("d-none");
    }

    async function runFakeLoading(minMs=2700, maxMs=5400){
      const total = Math.floor(minMs + Math.random() * (maxMs - minMs));
      const start = performance.now();

      let lastLineChange = 0;

      while(true){
        if(skipRequested) break;

        const now = performance.now();
        const elapsed = now - start;
        let t = Math.min(elapsed / total, 1);

        const eased = 1 - Math.pow(1 - t, 3);
        const pct = Math.floor(eased * 100);

        loadingBar.style.width = pct + "%";
        loadingPct.textContent = pct + "%";

        if(elapsed - lastLineChange > 900){
          lastLineChange = elapsed;
          loadingText.textContent = await fetchLoadingLine();
        }

        if(t >= 1) break;
        await sleep(40);
      }

      loadingBar.style.width = "100%";
      loadingPct.textContent = "100%";
      await sleep(120);
    }

    async function loadFact(){
        if(isLoading) return;
        isLoading = true;

        btn.disabled = true;

        // Start: grau / loading
        factText.classList.remove("fact-text", "fact-pop");
        factText.classList.add("fact-loading");
        factText.textContent = "…";

        await startLoadingUI();

        try{
            const factPromise = fetchFact();
            const loadingPromise = runFakeLoading();

            const [fact] = await Promise.all([factPromise, loadingPromise]);

            stopLoadingUI();

            // Ende: Fact weiß anzeigen
            factText.classList.remove("fact-loading");
            factText.classList.add("fact-text", "fact-pop");
            factText.textContent = fact;

            setTimeout(() => factText.classList.remove("fact-pop"), 250);
        }catch(e){
            stopLoadingUI();
            factText.classList.remove("fact-text");
            factText.classList.add("fact-loading");
            factText.textContent = "Fehler beim Laden.";
        }finally{
            btn.disabled = false;
            isLoading = false;
        }
        }

    btn.addEventListener("click", loadFact);
    btnSkip.addEventListener("click", () => { skipRequested = true; });
  </script>
</body>
</html>
